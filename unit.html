
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>è¬ç”¨è½åŠ›æ¸¬é©—</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    .question { display: none; margin-bottom: 30px; }
    .options label { display: block; margin: 5px 0; }
    .feedback { font-weight: bold; margin-top: 10px; }
    .correct { color: green; }
    .incorrect { color: red; }
    button { margin-right: 10px; }
  </style>
</head>
<body>
<h1 id="unitTitle">ğŸ§ è¬ç”¨è½åŠ›æ¸¬é©—</h1>
<p id="scoreboard">ç›®å‰å¾—åˆ†ï¼š0 åˆ†</p>
<div id="questionArea"></div>
<p id="result" style="font-weight:bold;"></p>

<script>
let score = 0;
let correct = [];
let questions = [];
let currentQueue = [];
let currentIndex = 0;
let perScore = 0;

const unit = new URLSearchParams(window.location.search).get("unit") || "U1";
document.getElementById("unitTitle").innerText = "ğŸ§ " + unit + " è½åŠ›æ¸¬é©—";

fetch("quiz-data.json")
  .then(res => res.json())
  .then(data => {
    questions = data.filter(q => q.unit === unit);
    const totalScore = questions[0]?.totalScore || 100;
    perScore = Math.round(totalScore / questions.length);
    correct = new Array(questions.length).fill(false);
    currentQueue = [...Array(questions.length).keys()];
    renderQuestion(currentQueue[currentIndex]);
  });

function renderQuestion(idx) {
  const q = questions[idx];
  let html = `
    <p><strong>è«‹å•ä½ è½åˆ°çš„æ˜¯å“ªä¸€å¥ï¼Ÿ</strong></p>
    <audio controls src="${q.audio}"></audio>
    <div class="options">
      ${q.choices.map((opt, i) => `<label><input type="radio" name="q${idx}" value="${i}"> ${opt}</label>`).join("")}
    </div>
    <p class="feedback" id="f${idx}"></p>
    <button onclick="checkAnswer(${idx})" id="submit${idx}">é€å‡ºç­”æ¡ˆ</button>
    <button onclick="showAnswer(${idx})" id="explain${idx}" style="display:none">çœ‹ç­”æ¡ˆ</button>
    <button onclick="nextQuestion()" id="next${idx}" style="display:none">ä¸‹ä¸€é¡Œ</button>`;
  document.getElementById("questionArea").innerHTML = `<div class="question" id="q${idx}">` + html + "</div>";
  document.getElementById("q" + idx).style.display = "block";
}

function checkAnswer(idx) {
  const radios = document.getElementsByName("q" + idx);
  let selected = -1;
  for (const r of radios) if (r.checked) selected = parseInt(r.value);
  if (selected === -1) {
    alert("è«‹é¸æ“‡ä¸€å€‹é¸é …ï¼");
    return;
  }
  document.getElementById("submit" + idx).style.display = "none";
  if (selected === questions[idx].answer) {
    if (!correct[idx]) {
      score += perScore;
      correct[idx] = true;
    }
    document.getElementById("f" + idx).textContent = `âœ… ç­”å°äº†ï¼ï¼ˆ+${perScore}åˆ†ï¼‰`;
    document.getElementById("f" + idx).className = "feedback correct";
  } else {
    document.getElementById("f" + idx).textContent = "âŒ ç­”éŒ¯äº†";
    document.getElementById("f" + idx).className = "feedback incorrect";
  }
  document.getElementById("scoreboard").textContent = "ç›®å‰å¾—åˆ†ï¼š" + score + " åˆ†";
  document.getElementById("explain" + idx).style.display = "inline";
  document.getElementById("next" + idx).style.display = "inline";
}

function showAnswer(idx) {
  alert("æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š" + questions[idx].choices[questions[idx].answer]);
}

function nextQuestion() {
  currentIndex++;
  if (currentIndex < currentQueue.length) {
    renderQuestion(currentQueue[currentIndex]);
  } else {
    const retry = correct.map((c, i) => (!c ? i : null)).filter(i => i !== null);
    if (retry.length === 0) {
      document.getElementById("questionArea").innerHTML = "";
      document.getElementById("result").innerHTML = `ğŸ‰ ä½ ç¸½å…±å¾—åˆ° ${score} åˆ†ï¼å…¨éƒ¨å®Œæˆ ${unit}ï¼<br><br><a href='unit.html?unit=U2'><button>å‰å¾€ä¸‹ä¸€å–®å…ƒ</button></a>`;
    } else {
      currentQueue = retry;
      currentIndex = 0;
      alert("è«‹é‡åšéŒ¯çš„é¡Œç›®");
      renderQuestion(currentQueue[0]);
    }
  }
}
</script>
</body>
</html>
