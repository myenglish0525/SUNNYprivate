
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>萬用聽力測驗</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    .question { display: none; margin-bottom: 30px; }
    .options label { display: block; margin: 5px 0; }
    .feedback { font-weight: bold; margin-top: 10px; }
    .correct { color: green; }
    .incorrect { color: red; }
    button { margin-right: 10px; }
  </style>
</head>
<body>
<h1 id="unitTitle">🎧 萬用聽力測驗</h1>
<p id="scoreboard">目前得分：0 分</p>
<div id="questionArea"></div>
<p id="result" style="font-weight:bold;"></p>

<script>
let score = 0;
let correct = [];
let questions = [];
let currentQueue = [];
let currentIndex = 0;
let perScore = 0;

const unit = new URLSearchParams(window.location.search).get("unit") || "U1";
document.getElementById("unitTitle").innerText = "🎧 " + unit + " 聽力測驗";

fetch("quiz-data.json")
  .then(res => res.json())
  .then(data => {
    questions = data.filter(q => q.unit === unit);
    const totalScore = questions[0]?.totalScore || 100;
    perScore = Math.round(totalScore / questions.length);
    correct = new Array(questions.length).fill(false);
    currentQueue = [...Array(questions.length).keys()];
    renderQuestion(currentQueue[currentIndex]);
  });

function renderQuestion(idx) {
  const q = questions[idx];
  let html = `
    <p><strong>請問你聽到的是哪一句？</strong></p>
    <audio controls src="${q.audio}"></audio>
    <div class="options">
      ${q.choices.map((opt, i) => `<label><input type="radio" name="q${idx}" value="${i}"> ${opt}</label>`).join("")}
    </div>
    <p class="feedback" id="f${idx}"></p>
    <button onclick="checkAnswer(${idx})" id="submit${idx}">送出答案</button>
    <button onclick="showAnswer(${idx})" id="explain${idx}" style="display:none">看答案</button>
    <button onclick="nextQuestion()" id="next${idx}" style="display:none">下一題</button>`;
  document.getElementById("questionArea").innerHTML = `<div class="question" id="q${idx}">` + html + "</div>";
  document.getElementById("q" + idx).style.display = "block";
}

function checkAnswer(idx) {
  const radios = document.getElementsByName("q" + idx);
  let selected = -1;
  for (const r of radios) if (r.checked) selected = parseInt(r.value);
  if (selected === -1) {
    alert("請選擇一個選項！");
    return;
  }
  document.getElementById("submit" + idx).style.display = "none";
  if (selected === questions[idx].answer) {
    if (!correct[idx]) {
      score += perScore;
      correct[idx] = true;
    }
    document.getElementById("f" + idx).textContent = `✅ 答對了！（+${perScore}分）`;
    document.getElementById("f" + idx).className = "feedback correct";
  } else {
    document.getElementById("f" + idx).textContent = "❌ 答錯了";
    document.getElementById("f" + idx).className = "feedback incorrect";
  }
  document.getElementById("scoreboard").textContent = "目前得分：" + score + " 分";
  document.getElementById("explain" + idx).style.display = "inline";
  document.getElementById("next" + idx).style.display = "inline";
}

function showAnswer(idx) {
  alert("正確答案是：" + questions[idx].choices[questions[idx].answer]);
}

function nextQuestion() {
  currentIndex++;
  if (currentIndex < currentQueue.length) {
    renderQuestion(currentQueue[currentIndex]);
  } else {
    const retry = correct.map((c, i) => (!c ? i : null)).filter(i => i !== null);
    if (retry.length === 0) {
      document.getElementById("questionArea").innerHTML = "";
      document.getElementById("result").innerHTML = `🎉 你總共得到 ${score} 分！全部完成 ${unit}！<br><br><a href='unit.html?unit=U2'><button>前往下一單元</button></a>`;
    } else {
      currentQueue = retry;
      currentIndex = 0;
      alert("請重做錯的題目");
      renderQuestion(currentQueue[0]);
    }
  }
}
</script>
</body>
</html>
